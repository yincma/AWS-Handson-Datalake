#!/bin/bash

# =============================================================================
# ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯çµ±ä¸€CLI - datalake ã‚³ãƒãƒ³ãƒ‰
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 2.0.0
# èª¬æ˜: ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ä½¿ç”¨ã—ãŸçµ±ä¸€ç®¡ç†CLI
# =============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
source "$SCRIPT_DIR/../lib/common.sh"

readonly DATALAKE_CLI_VERSION="2.0.0"

# =============================================================================
# CLIãƒ˜ãƒ«ãƒ—è¡¨ç¤º
# =============================================================================

show_help() {
    cat << 'EOF'
ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯çµ±ä¸€ç®¡ç†CLI (v2.0.0)

ä½¿ç”¨æ–¹æ³•:
  datalake [ã‚³ãƒãƒ³ãƒ‰] [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]

åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:

ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ç®¡ç†:
  deploy [--full] [--emr] [--analytics]  å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Ÿè¡Œ
  destroy [--force] [--deep-clean]      å…¨ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤
  status                                 ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
  validate                               è¨­å®šæ¤œè¨¼

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†:
  module <action> <module_name>         å€‹åˆ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ“ä½œ
    - actions: validate, deploy, status, cleanup, rollback
    - modules: s3_storage, iam_roles, glue_catalog, lake_formation,
               emr_cluster, cost_monitoring, cloudtrail_logging

ãƒ‡ãƒ¼ã‚¿æ“ä½œ:
  upload [--sample-data]                ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  analytics                             åˆ†æã‚¸ãƒ§ãƒ–å®Ÿè¡Œ
  query <sql_file>                      Athenaã‚¯ã‚¨ãƒªå®Ÿè¡Œ

ç›£è¦–ãƒ»ç®¡ç†:
  costs                                 ã‚³ã‚¹ãƒˆåˆ†æ
  logs [--hours <N>]                    CloudTrailãƒ­ã‚°è¡¨ç¤º
  security                              ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ
  monitoring                            ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–

ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£:
  config [--validate] [--export]        è¨­å®šç®¡ç†
  version                              ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º
  help                                 ã“ã®ãƒ˜ãƒ«ãƒ—è¡¨ç¤º

ä¾‹:
  # åŸºæœ¬ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
  datalake deploy

  # EMRã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’å«ã‚€å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤
  datalake deploy --full

  # å€‹åˆ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ“ä½œ
  datalake module deploy s3_storage
  datalake module status emr_cluster

  # ã‚³ã‚¹ãƒˆç›£è¦–
  datalake costs

  # å®Œå…¨ãªå‰Šé™¤
  datalake destroy --force --deep-clean

è©³ç´°æƒ…å ±ã«ã¤ã„ã¦ã¯ã€å„ã‚³ãƒãƒ³ãƒ‰ã« --help ã‚’ä»˜ã‘ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
EOF
}

# =============================================================================
# ã‚³ãƒãƒ³ãƒ‰å‡¦ç†é–¢æ•°
# =============================================================================

cmd_deploy() {
    print_step "ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹"
    
    local full_deploy=false
    local deploy_emr=false  
    local run_analytics=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --full)
                full_deploy=true
                deploy_emr=true
                run_analytics=true
                shift
                ;;
            --emr)
                deploy_emr=true
                shift
                ;;
            --analytics)
                run_analytics=true
                shift
                ;;
            --help|-h)
                cat << EOF
ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰

ä½¿ç”¨æ–¹æ³•:
  datalake deploy [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]

ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
  --full        EMRã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¨åˆ†æã‚¸ãƒ§ãƒ–ã‚’å«ã‚€å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤
  --emr         EMRã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤
  --analytics   åˆ†æã‚¸ãƒ§ãƒ–ã‚‚å®Ÿè¡Œï¼ˆEMRå¿…é ˆï¼‰
  --help, -h    ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ä¾‹:
  datalake deploy              # åŸºæœ¬ã‚¤ãƒ³ãƒ•ãƒ©ã®ã¿
  datalake deploy --full       # å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤
  datalake deploy --emr        # EMRä»˜ããƒ‡ãƒ—ãƒ­ã‚¤
EOF
                return 0
                ;;
            *)
                print_error "ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
                return 1
                ;;
        esac
    done
    
    # è¨­å®šã‚’èª­ã¿è¾¼ã¿
    load_config "$PROJECT_ROOT/configs/config.env"
    
    # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨å¹¶è¡Œç¼–æ’å™¨
    local orchestrator="$PROJECT_ROOT/scripts/core/deployment/parallel_orchestrator.sh"
    if [[ -f "$orchestrator" && "$full_deploy" == "true" ]]; then
        print_info "ä½¿ç”¨å¹¶è¡Œç¼–æ’å™¨è¿›è¡Œå®Œæ•´éƒ¨ç½²"
        
        # ä½¿ç”¨å¹¶è¡Œç¼–æ’å™¨çš„æ ‡å‡†deployå‘½ä»¤
        "$orchestrator" deploy
        
        if [[ "$run_analytics" == "true" ]]; then
            print_info "æ‰§è¡Œåˆ†æä½œä¸š..."
            cmd_analytics
        fi
        
        print_success "æ•°æ®æ¹–ç³»ç»Ÿéƒ¨ç½²å®Œæˆ"
    else
        print_warning "ä½¿ç”¨ä¼ ç»Ÿè„šæœ¬è¿›è¡Œéƒ¨ç½²"
        
        # Bash 3.xå…¼å®¹çš„å‚æ•°å¤„ç†
        local deploy_args=""
        if [[ "$deploy_emr" == "true" ]]; then
            deploy_args="$deploy_args --with-emr"
        fi
        if [[ "$run_analytics" == "true" ]]; then
            deploy_args="$deploy_args --with-analytics"
        fi
        
        # è®¾ç½®ç¯å¢ƒå˜é‡é˜²æ­¢é€’å½’è°ƒç”¨
        export CALLED_FROM_CLI=true
        
        # æ‰§è¡Œä¼ ç»Ÿéƒ¨ç½²è„šæœ¬
        if [[ -n "$deploy_args" ]]; then
            "$PROJECT_ROOT/scripts/deploy-all.sh" $deploy_args
        else
            "$PROJECT_ROOT/scripts/deploy-all.sh"
        fi
    fi
}

cmd_destroy() {
    local force=false
    local deep_clean=false
    local retry_failed=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --force)
                force=true
                shift
                ;;
            --deep-clean)
                deep_clean=true
                shift
                ;;
            --retry-failed)
                retry_failed=true
                shift
                ;;
            --help|-h)
                cat << EOF
ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯å‰Šé™¤ã‚³ãƒãƒ³ãƒ‰

ä½¿ç”¨æ–¹æ³•:
  datalake destroy [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]

ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
  --force           ç¢ºèªãªã—ã§å‰Šé™¤å®Ÿè¡Œ
  --deep-clean      S3ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚å‰Šé™¤
  --retry-failed    å¤±æ•—ã—ãŸã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤ã‚’å†è©¦è¡Œ
  --help, -h        ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ä¾‹:
  datalake destroy                           # é€šå¸¸å‰Šé™¤
  datalake destroy --force --deep-clean     # å®Œå…¨å‰Šé™¤
EOF
                return 0
                ;;
            *)
                print_error "ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
                return 1
                ;;
        esac
    done
    
    if [[ "$force" != "true" ]]; then
        print_warning "å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚"
        echo -n "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): "
        read -r response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            print_info "å‰Šé™¤æ“ä½œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"
            return 0
        fi
    fi
    
    print_step "ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤ã‚’é–‹å§‹"
    
    # è¨­å®šã‚’èª­ã¿è¾¼ã¿
    load_config "$PROJECT_ROOT/configs/config.env"
    
    # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é †åºã§å‰Šé™¤ï¼ˆä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ï¼‰
    local cleanup_modules=("emr_cluster" "cost_monitoring" "cloudtrail_logging" "lake_formation" "glue_catalog" "iam_roles" "s3_storage")
    
    for module in "${cleanup_modules[@]}"; do
        local module_script="$PROJECT_ROOT/scripts/core/*/${module}.sh"
        local found_script
        found_script=$(find "$PROJECT_ROOT/scripts/core" -name "${module}.sh" 2>/dev/null | head -1)
        
        if [[ -n "$found_script" ]]; then
            print_info "ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‰Šé™¤: $module"
            "$found_script" cleanup || print_warning "ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« $module å‰Šé™¤ã«å¤±æ•—"
        fi
    done
    
    if [[ "$deep_clean" == "true" ]]; then
        # S3æ·±åº¦å‰Šé™¤ã¯æ—¢ã«s3_storage_cleanupã§å®Ÿè¡Œæ¸ˆã¿
        print_debug "S3æ·±åº¦å‰Šé™¤ã¯å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®cleanupå‡¦ç†ã§å®Ÿè¡Œæ¸ˆã¿"
    fi
    
    print_success "ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤ãŒå®Œäº†"
}

cmd_status() {
    print_step "ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª"
    
    load_config "$PROJECT_ROOT/configs/config.env"
    
    # å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    local modules=("s3_storage" "iam_roles" "glue_catalog" "lake_formation" "emr_cluster" "cost_monitoring" "cloudtrail_logging")
    local healthy_modules=0
    local total_modules=${#modules[@]}
    
    for module in "${modules[@]}"; do
        local found_script
        found_script=$(find "$PROJECT_ROOT/scripts/core" -name "${module}.sh" 2>/dev/null | head -1)
        
        if [[ -n "$found_script" ]]; then
            if "$found_script" status &>/dev/null; then
                print_success "âœ… $module: æ­£å¸¸"
                ((healthy_modules++))
            else
                print_warning "âš ï¸ $module: ç•°å¸¸ã¾ãŸã¯æœªãƒ‡ãƒ—ãƒ­ã‚¤"
            fi
        else
            print_error "âŒ $module: ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
    done
    
    echo
    print_info "ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹: $healthy_modules/$total_modules ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæ­£å¸¸"
    
    if [[ $healthy_modules -eq $total_modules ]]; then
        print_success "ğŸ‰ ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ã‚·ã‚¹ãƒ†ãƒ ã¯å®Œå…¨ã«ç¨¼åƒä¸­"
        return 0
    else
        print_warning "âš ï¸ ã„ãã¤ã‹ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å•é¡ŒãŒã‚ã‚Šã¾ã™"
        return 1
    fi
}

cmd_module() {
    local action="${1:-}"
    local module_name="${2:-}"
    
    if [[ -z "$action" || -z "$module_name" ]]; then
        print_error "ä½¿ç”¨æ–¹æ³•: datalake module <action> <module_name>"
        print_info "Actions: validate, deploy, status, cleanup, rollback"
        print_info "Modules: s3_storage, iam_roles, glue_catalog, lake_formation, emr_cluster, cost_monitoring, cloudtrail_logging"
        return 1
    fi
    
    # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ¤œç´¢
    local found_script
    found_script=$(find "$PROJECT_ROOT/scripts/core" -name "${module_name}.sh" 2>/dev/null | head -1)
    
    if [[ -n "$found_script" ]]; then
        print_info "$module_name ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ $action ã‚’å®Ÿè¡Œ"
        "$found_script" "$action" "${@:3}"
    else
        print_error "ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« $module_name ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        return 1
    fi
}

cmd_costs() {
    local cost_script="$PROJECT_ROOT/scripts/core/monitoring/cost_monitoring.sh"
    if [[ -f "$cost_script" ]]; then
        "$cost_script" report
    else
        print_warning "ã‚³ã‚¹ãƒˆãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"
        "$PROJECT_ROOT/scripts/cost-optimization.sh"
    fi
}

cmd_logs() {
    local hours=1
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --hours)
                hours="$2"
                shift 2
                ;;
            *)
                hours="$1"
                shift
                ;;
        esac
    done
    
    local cloudtrail_script="$PROJECT_ROOT/scripts/core/monitoring/cloudtrail_logging.sh"
    if [[ -f "$cloudtrail_script" ]]; then
        "$cloudtrail_script" logs "$hours"
    else
        print_error "CloudTrailãƒ­ã‚°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"
        return 1
    fi
}

cmd_security() {
    local cloudtrail_script="$PROJECT_ROOT/scripts/core/monitoring/cloudtrail_logging.sh"
    if [[ -f "$cloudtrail_script" ]]; then
        "$cloudtrail_script" security
    else
        print_error "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"
        return 1
    fi
}

cmd_analytics() {
    print_step "åˆ†æã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œ"
    
    # EMR ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª
    local emr_script="$PROJECT_ROOT/scripts/core/compute/emr_cluster.sh"
    if [[ -f "$emr_script" ]] && "$emr_script" status &>/dev/null; then
        "$PROJECT_ROOT/scripts/submit_pyspark_job.sh"
    else
        print_error "EMRã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã¾ãš 'datalake module deploy emr_cluster' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
        return 1
    fi
}

cmd_config() {
    local validate_only=false
    local export_only=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --validate)
                validate_only=true
                shift
                ;;
            --export)
                export_only=true
                shift
                ;;
            *)
                print_error "ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
                return 1
                ;;
        esac
    done
    
    if [[ "$validate_only" == "true" ]]; then
        "$PROJECT_ROOT/scripts/lib/config/validator.sh"
    elif [[ "$export_only" == "true" ]]; then
        "$PROJECT_ROOT/scripts/utils/export_env_template.sh"
    else
        print_info "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: $PROJECT_ROOT/configs/config.env"
        if [[ -f "$PROJECT_ROOT/configs/config.local.env" ]]; then
            print_info "ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®š: $PROJECT_ROOT/configs/config.local.env"
        fi
        "$PROJECT_ROOT/scripts/lib/config/validator.sh"
    fi
}

cmd_version() {
    echo "datalake CLI ãƒãƒ¼ã‚¸ãƒ§ãƒ³ $DATALAKE_CLI_VERSION"
    echo "ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ™ãƒ¼ã‚¹ AWS ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ç®¡ç†ãƒ„ãƒ¼ãƒ«"
}

# =============================================================================
# ãƒ¡ã‚¤ãƒ³ã‚³ãƒãƒ³ãƒ‰å‡¦ç†
# =============================================================================

main() {
    # å¼•æ•°ãŒãªã„å ´åˆã¯ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
    if [[ $# -eq 0 ]]; then
        show_help
        return 0
    fi
    
    local command="$1"
    shift
    
    case "$command" in
        deploy)
            cmd_deploy "$@"
            ;;
        destroy)
            cmd_destroy "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        validate)
            load_config "$PROJECT_ROOT/configs/config.env"
            "$PROJECT_ROOT/scripts/lib/config/validator.sh"
            ;;
        module)
            cmd_module "$@"
            ;;
        upload)
            print_info "ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
            # TODO: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
            ;;
        analytics)
            cmd_analytics "$@"
            ;;
        query)
            print_info "Athenaã‚¯ã‚¨ãƒªå®Ÿè¡Œ"
            # TODO: Athenaã‚¯ã‚¨ãƒªå®Ÿè¡Œæ©Ÿèƒ½
            ;;
        costs)
            cmd_costs "$@"
            ;;
        logs)
            cmd_logs "$@"
            ;;
        security)
            cmd_security "$@"
            ;;
        monitoring)
            print_info "ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"
            cmd_status
            ;;
        config)
            cmd_config "$@"
            ;;
        version)
            cmd_version
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: $command"
            echo
            show_help
            return 1
            ;;
    esac
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸå ´åˆ
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi